<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - DentalDesign.Dashboard</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/DentalDesign.Dashboard.styles.css" asp-append-version="true" />
</head>
<body>
    <header>
        @await Component.InvokeAsync("Navbar")
    </header>
    <div class="d-flex">
        @await Component.InvokeAsync("Sidebar")


        <div id="mainContent" class="flex-grow-1 p-3">
            
                @RenderBody()
        </div>
    </div>
    
    @await Html.PartialAsync("_DeleteConfirmModal")

    <footer class="border-top footer text-muted">
        <div class="container">
            &copy; 2025 - DentalDesign.Dashboard - <a asp-area="" asp-controller="Home" asp-action="Privacy">Privacy</a>
        </div>
    </footer>

    
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)


    <script>
        // ✅ Global variables
        let mainContent;

        /**
         * Loads a page via AJAX and injects it into #mainContent.
         * param {string} url - The URL to load
         * param {boolean} pushState - Whether to update browser history
         */
        function loadPage(url, pushState = true) {
            fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
                .then(res => {
                    if (!res.ok) throw new Error('Network response was not ok');
                    return res.text();
                })
                .then(html => {
                    mainContent.innerHTML = html;

                    // Update sidebar active state
                    const pathname = new URL(url, window.location.origin).pathname;
                    document.querySelectorAll(".sidebar-wrapper li").forEach(li => li.classList.remove("active"));
                    const activeLink = document.querySelector(`.sidebar-wrapper a[href^='${pathname}']`);
                    if (activeLink) activeLink.parentElement.classList.add("active");

                    if (pushState) {
                        history.pushState({ url: url }, "", url);
                    }

                    // Re-bind dynamic handlers
                    bindDynamicEventHandlers();
                })
                .catch(err => {
                    console.error("Failed to load page:", err);
                    alert("Failed to load page. Please try again.");
                });
        }

        /**
         * Binds event handlers to dynamically loaded content
         */
        function bindDynamicEventHandlers() {
            // .ajax-link
            document.querySelectorAll(".ajax-link").forEach(link => {
                if (!link.dataset.bound) {
                    link.addEventListener("click", function (e) {
                        e.preventDefault();
                        loadPage(this.href);
                    });
                    link.dataset.bound = "true";
                }
            });

            // Search form
            const searchForm = document.querySelector('form[method="get"][asp-action="Index"]');
            if (searchForm && !searchForm.dataset.bound) {
                searchForm.addEventListener("submit", function (e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const queryString = new URLSearchParams(formData).toString();
                    const url = this.action + (queryString ? '?' + queryString : '');
                    loadPage(url);
                });
                searchForm.dataset.bound = "true";
            }

            // Pagination
            document.querySelectorAll(".pagination .page-link").forEach(link => {
                if (!link.dataset.bound) {
                    link.addEventListener("click", function (e) {
                        e.preventDefault();
                        loadPage(this.href);
                    });
                    link.dataset.bound = "true";
                }
            });
        }

        // ✅ Delete Modal Functions
        function openDeleteSingle(id, config = {}) {
            const endpoint = config.endpoint || '';
            const title = config.title || 'Delete Item';
            const message = config.message || 'Are you sure you want to delete this item?';

            document.getElementById('deleteIds').value = id;
            document.getElementById('deleteFormModal').action = endpoint;
            document.getElementById('deleteTitle').innerText = title;
            document.getElementById('deleteMessage').innerHTML = `
                <p class="mb-2">${message}</p>
                <p class="text-muted small">This action cannot be undone.</p>
            `;
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        function openDeleteSelected(config = {}) {
            const endpoint = config.endpoint || '';
            const title = config.title || 'Delete Selected Items';
            const messagePrefix = config.messagePrefix || 'items';

            const selected = [...document.querySelectorAll('input[name="selectedIds"]:checked')].map(c => c.value);
            if (selected.length === 0) {
                alert('No items selected.');
                return;
            }

            document.getElementById('deleteIds').value = selected.join(',');
            document.getElementById('deleteFormModal').action = endpoint;
            document.getElementById('deleteTitle').innerText = title;
            document.getElementById('deleteMessage').innerHTML = `
                <p class="mb-2">Are you sure you want to delete <strong>${selected.length}</strong> ${messagePrefix}?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            `;
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        function submitGlobalDelete(event) {
            event.preventDefault();
            const form = document.getElementById('deleteFormModal');
            const url = form.action;
            const ids = document.getElementById('deleteIds').value;
            const modalElement = document.getElementById('deleteConfirmModal');
            const modal = bootstrap.Modal.getInstance(modalElement);

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `ids=${encodeURIComponent(ids)}`
            })
            .then(async res => {
                if (res.ok) {
                    // ✅ Close modal first
                    if (modal) modal.hide();

                    // Reload current page via AJAX
                    loadPage(location.href, false);
                } else {
                    // Try to get error message from response
                    const errorMessage = await res.text().catch(() => 'Unknown error');
                    throw new Error(errorMessage || 'Delete operation failed');
                }
            })
            .catch(err => {
                console.error("Delete failed:", err);
                alert(err.message || "An error occurred during deletion.");
                // Modal remains open on error (good UX)
            });
        }

        // ✅ Initialize on DOM ready
        document.addEventListener("DOMContentLoaded", function () {
            mainContent = document.getElementById("mainContent");

            // Sidebar links
            document.querySelectorAll(".sidebar-wrapper a").forEach(a => {
                a.addEventListener("click", function (e) {
                    e.preventDefault();
                    loadPage(this.href);
                });
            });

            // Back/forward navigation
            window.addEventListener("popstate", function () {
                loadPage(location.href, false);
            });

            // Initial binding
            bindDynamicEventHandlers();
        });
    </script>

</body>
</html>
